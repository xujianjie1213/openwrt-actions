name: AutoBuild W212x with Small-Package

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      target_device:
        description: 'Target device to build'
        required: true
        default: 'rt-w212x'
        type: choice
        options:
          - rt-360v6
          - rt-ax18
          - rt-w212x
      ssh:
        description: 'Enable SSH connection to Actions'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      include_small_package:
        description: 'Include small-package feeds'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  # 项目配置
  ASUS_REPO_URL: https://github.com/stkuroneko/asuswrt-ipq6018.git
  TOOLCHAIN_REPO_URL: https://github.com/SWRT-dev/qca-toolchains
  SMALL_PACKAGE_URL: https://github.com/kenzok8/small-package
  ASUS_BUILD_DIR: asuswrt-ipq6018-build
  WORKSPACE: ${{ github.workspace }}
  
  # 自定义脚本
  DIY_P1_SH: diy1.sh
  DIY_P2_SH: diy2.sh
  
  # 通用配置
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 检查磁盘空间
      run: |
        echo "编译开始前磁盘空间"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: 优化磁盘空间
      uses: hugoalh/disk-space-optimizer-ghaction@v0.8.0
      with:
        operate_sudo: "True"
        docker_prune: "True"
        docker_clean: "True"
        apt_prune: "True"
        apt_clean: "True"
        npm_prune: "True"
        npm_clean: "True"
        os_swap: "True"

    - name: 释放磁盘空间
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: 磁盘空间释放完成
      run: |
        echo "磁盘空间释放完成"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: 检查代码
      uses: actions/checkout@v3
      with:
        path: config-files
    
    - name: 安装ASUS固件编译环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        
        # ASUS固件编译依赖
        sudo dpkg --add-architecture i386
        sudo -E apt-get -qq update
        
        sudo -E apt-get -qq install -y \
          build-essential asciidoc binutils bzip2 gawk gettext git \
          libncurses5-dev libz-dev patch python3 python2.7 unzip \
          zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs \
          git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo \
          libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake \
          libtool autopoint device-tree-compiler g++-multilib antlr3 gperw \
          wget libncurses5:i386 libelf1:i386 lib32z1 lib32stdc++6 \
          gtk-doc-tools intltool binutils-dev cmake lzma liblzma-dev \
          lzma-dev uuid-dev liblzo2-dev xsltproc dos2unix libstdc++5 \
          docbook-xsl-* sharutils autogen shtool gengetopt libltdl-dev \
          libtool-bin curl cpio rsync help2man swig bison
        
        # 清理
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"

    - name: 下载ASUS固件源码
      run: |
        echo "下载ASUS固件源码..."
        git clone $ASUS_REPO_URL asuswrt-ipq6018 --depth=1
        
        echo "下载工具链..."
        git clone $TOOLCHAIN_REPO_URL --depth=1
        
        if [ "${{ github.event.inputs.include_small_package }}" = "true" ]; then
          echo "下载small-package..."
          git clone $SMALL_PACKAGE_URL --depth=1
        fi

    - name: 应用自定义脚本 (阶段1)
      run: |
        if [ -f "config-files/$DIY_P1_SH" ]; then
          echo "执行自定义脚本: $DIY_P1_SH"
          chmod +x "config-files/$DIY_P1_SH"
          cd "config-files"
          ./$DIY_P1_SH
        else
          echo "未找到自定义脚本: $DIY_P1_SH"
        fi

    - name: 准备构建目录
      run: |
        mkdir -p $ASUS_BUILD_DIR
        echo "同步源码到构建目录..."
        rsync -a --delete asuswrt-ipq6018/ $ASUS_BUILD_DIR/
        
        # 将small-package集成到ASUS固件构建系统中
        if [ "${{ github.event.inputs.include_small_package }}" = "true" ] && [ -d "small-package" ]; then
          echo "集成small-package到ASUS固件..."
          
          # 创建package目录（如果不存在）
          mkdir -p $ASUS_BUILD_DIR/release/src-qca-cypress/package/small-package
          
          # 复制small-package中的软件包
          cp -r small-package/* $ASUS_BUILD_DIR/release/src-qca-cypress/package/small-package/ 2>/dev/null || true
          
          # 如果ASUS固件有feeds.conf，添加small-package源
          if [ -f "$ASUS_BUILD_DIR/release/src-qca-cypress/feeds.conf.default" ]; then
            echo "src-link small-package $WORKSPACE/$ASUS_BUILD_DIR/release/src-qca-cypress/package/small-package" >> $ASUS_BUILD_DIR/release/src-qca-cypress/feeds.conf.default
          fi
          
          # 创建自定义feeds配置
          echo "创建自定义feeds配置..."
          cat > $ASUS_BUILD_DIR/release/src-qca-cypress/small-package-feeds.conf << EOF
          # Small Package feeds
          src-git packages https://git.openwrt.org/feed/packages.git
          src-git luci https://git.openwrt.org/project/luci.git
          src-git routing https://git.openwrt.org/feed/routing.git
          src-git telephony https://git.openwrt.org/feed/telephony.git
          src-link small-package $WORKSPACE/$ASUS_BUILD_DIR/release/src-qca-cypress/package/small-package
          EOF
          
          echo "small-package集成完成"
        fi

    - name: 设置工具链
      run: |
        echo "设置工具链..."
        cd qca-toolchains
        sudo mkdir -p /opt
        sudo ln -sf $(pwd)/openwrt-gcc520_musl.arm /opt/
        sudo chmod -R +x openwrt-gcc520_musl.arm/
        
        # 验证工具链
        if [ -f "/opt/openwrt-gcc520_musl.arm/bin/arm-openwrt-linux-gcc" ]; then
          echo "工具链设置成功"
          /opt/openwrt-gcc520_musl.arm/bin/arm-openwrt-linux-gcc --version || true
        else
          echo "警告: 工具链可能未正确设置"
        fi

    - name: 应用自定义脚本 (阶段2)
      run: |
        if [ -f "config-files/$DIY_P2_SH" ]; then
          echo "执行自定义脚本: $DIY_P2_SH"
          chmod +x "config-files/$DIY_P2_SH"
          cd $ASUS_BUILD_DIR/release/src-qca-cypress
          $WORKSPACE/config-files/$DIY_P2_SH
        else
          echo "未找到自定义脚本: $DIY_P2_SH"
        fi

    - name: SSH连接（调试用）
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: 开始编译固件
      run: |
        echo "开始编译ASUS固件..."
        echo "目标设备: ${{ github.event.inputs.target_device }}"
        echo "包含small-package: ${{ github.event.inputs.include_small_package }}"
        
        cd $ASUS_BUILD_DIR/release/src-qca-cypress
        
        # 检查small-package集成情况
        if [ "${{ github.event.inputs.include_small_package }}" = "true" ]; then
          echo "检查small-package..."
          if [ -d "package/small-package" ]; then
            echo "small-package目录存在，包含以下软件包:"
            ls -la package/small-package/ || echo "无法列出small-package内容"
          else
            echo "警告: small-package目录不存在"
          fi
        fi
        
        # 编译固件
        echo "开始编译..."
        make ${{ github.event.inputs.target_device }} -j$(nproc) || make ${{ github.event.inputs.target_device }} -j1 || make ${{ github.event.inputs.target_device }} V=s
        
        echo "编译完成"
        
        # 设置输出变量
        DEVICE_NAME="${{ github.event.inputs.target_device }}"
        echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: 查看编译输出
      run: |
        echo "查找编译输出文件..."
        cd $ASUS_BUILD_DIR/release/src-qca-cypress/image
        find . -type f -name "*.trx" -o -name "*.bin" -o -name "*.img" | while read file; do
          echo "固件文件: $file"
          ls -lh "$file"
        done
        
        # 设置固件路径环境变量
        echo "FIRMWARE_PATH=$WORKSPACE/$ASUS_BUILD_DIR/release/src-qca-cypress/image" >> $GITHUB_ENV

    - name: 查看磁盘使用情况
      if: (!cancelled())
      run: df -hT

    - name: 上传固件
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: 创建release标签
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "::set-output name=release_tag::$(date +"%Y.%m.%d-%H%M")"
        echo "::set-output name=status::success"

    - name: 发布至release
      if: steps.tag.outputs.status == 'success' && !cancelled()
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: ASUS固件 ${{ env.DEVICE_NAME }} ${{ env.FILE_DATE }}
        files: ${{ env.ASUS_BUILD_DIR }}/release/src-qca-cypress/image/*

    - name: 清理旧的workflow
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: 清理旧的release
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      uses: dev-drprasad/delete-older-releases@v0.1.0
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
